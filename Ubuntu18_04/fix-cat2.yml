---
- name: CAT II | UBTU-18-010002 | The Ubuntu operating system must initiate session audits at system startup
  block:
    - name: CAT II | UBTU-18-010002 | Configuring the Ubuntu operating system to produce audit records at system startup
      lineinfile:
        path: /dev/mapper/ubuntu
        regexp: '^linux /vmlinuz-4.15.0-55-generic root=/dev/mapper/ubuntu--vg-root ro quiet splash $vt_handoff audit=1'
        set: "{{ audit=1 }}"
        state: present

    - name: CAT II | UBTU-18-010002 | Updating the grub config file run
      shell: update-grub
      become: true
##########################################
- name: CAT II | UBTU-18-010003 | Ubuntu operating systems handling data requiring data at rest protections must employ cryptographic mechanisms
  block:
    - name: Determine the partition layout for the system
      shell: fdisk -l
      become: true

##########################################
- name: CAT II | UBTU-18-010003 | Verify that /sys directory is absent
  # Use a regex expression to ensure that the /sys directory is absent
  block:
    - name: Check for /sys directory
      lineinfile:
        dest: /etc/crypttab
        regexp: '^/sys'
        state: absent
#####################################
- name: CAT II | UBTU-18-010016 | Advanced package tool (APT) must be configured
  lineinfile:
    path: /etc/apt/apt.conf.d/01-vendor-Ubuntu
    regexp: '^AllowUnauthenticated=false'
    set: "{{ AllowUnauthenticated=false }}"
  notify: restart apt
  when:
    - ubuntu_18_010424
############################################
- name: CAT II | UBTU-18-010017 | configure the (APT) so that it removes unused dependencies
  block:
    - name: do the check for remove-Unused-dependencies
      lineinfile:
        path: /etc/apt/apt.conf.d/50unattended-upgrades
        regexp: '^Unattended-Upgrade::Remove-Unused-Dependencies'
        set: "{{ Unattended-Upgrade::Remove-Unused-Dependencies=true }}"
        state: present
      notify: restart apt
      when:
        - ubuntu_18_010424

    - name: configure the (APT) so it removes Unused-Kernel-Packages
      lineinfile:
        path: /etc/apt/apt.conf.d/50unattended-upgrades
        regexp: '^Unattended-Upgrade::Remove-Unused-Kernel-Packages'
        set: "{{ Unattended-Upgrade::Remove-Unused-Dependencies=true }}"
        state: present
      notify: restart apt
      when:
        - ubuntu_18_010424
################################################
- name: CAT II | UBTU-18-010021 | Verify the Ubuntu operating system deploys ENSLTP
  shell: |
    dpkg -l | grep isectp
    ps -ef | grep isectpd
    apt-get install isectp
  become: true
#################################################
- name: CAT II | UBTU-18-010022 | Verify the log service is configured to collect system failure events
  shell: |
    dpkg -l | grep rsyslog
    systemctl is-enabled rsyslog
    systemctl is-active rsyslog
    apt-get install rsyslog
    systemctl enable rsyslog
    systemctl restart rsyslog
  become: true
######################################
- name: CAT II | UBTU-18-010023 | Verify that the Uncomplicated Firewall is installed
  shell: |
    apt-get install ufw
    dpkg -l | grep ufw
  become: true
######################################
- name: CAT II | UBTU-18-010033 | Check that Ubuntu operating system locks an account after three unsuccessful login attempts UBTU-18-010033-CATII
  lineinfile:
    dest: /etc/pam.d/common-auth
    regexp: '^auth required pam_tally2.so deny=3'
    set: "{{ deny=3 }}"
    state: present
#######################################
- name: CAT II | UBTU-18-010035 | The Ubuntu operating system must display the Standard Mandatory DoD Notice and Consent Banner
  lineinfile:
    dest: /etc/gdm3/greeter.dconf-defaults
    regexp: '^banner-message-enable=true'
    set: "{{ banner-message-enable=true }}"
    state: present
########################################
- name: CAT II | UBTU-18-010036 | Verify the Ubuntu operating system prevents direct logins to the root account.
  shell: |
    passwd -S root
  become: true
##########################################
- name: CAT II | UBTU-18-010038 | Check the specified banner file to check that it matches the Standard Mandatory DoD Notice and Consent Banner exactly
  block:
    - name: Ensure the banner message is present and matches
      lineinfile:
        dest: /etc/issue
        regexp: '^You are accessing a U.S. Government (USG) Information System (IS) that is provided for USG-authorized use only.'
        state: present
    - name: Configure the Ubuntu operating system to display the Standard Mandatory DoD Notice and Consent Banner before granting access to the system via SSH logon.
      lineinfile:
        dest: /etc/ssh/sshd_config
        regexp: '^Banner'
        set: "{{ Banner=/etc/issue }}"
    - name: restart the service
      shell: systemctl restart sshd.service
      become: true
#######################################
- name: CAT II | UBTU-18-010104 | Verify that the shadow password suite configuration is set to encrypt password with a FIPS 140-2 approved cryptographic hashing algorithm
  lineinfile:
    dest: /etc/login.defs
    regexp: '^ENCRYPT_METHOD'
    set: "{{ ENCRYPT_METHOD=SHA512 }}"
    state: present
#############################################
- name: CAT II | UBTU-18-010109 | The Ubuntu operating system must enforce a minimum 15-character password length.
  lineinfile:
    dest: /etc/security/pwquality.conf
    regexp: '^minlen'
    set: "{{ minlen=15 }}"
    state: present
##########################################
- name: CAT II | UBTU-18-010110 | The Ubuntu operating system must employ a FIPS 140-2 approved cryptographic hashing algorithms for all created and stored passwords.
  block:
    - name: Check that ENCRYPT_METHOD is set to sha512 in /etc/login.defs
      lineinfile:
        dest: /etc/login.defs
        regexp: '^ENCRYPT_METHOD'
        set: "{{ ENCRYPT_METHOD=SHA512 }}"

    - name: Configure the Ubuntu operating system to encrypt all stored passwords with a strong cryptographic hash.
      lineinfile:
        dest: /etc/pam.d/common-password
        regexp: '^password success=1 pam_unix.so obscure sha512'
        set: "{{ password success=1 pam_unix.so obscure sha512 }}"

    - name: Edit/modify /etc/login.defs and set "ENCRYPT_METHOD sha512"
      lineinfile:
        dest: /etc/login.defs
        regexp: '^ENCRYPT_METHOD'
        set: "{{ ENCRYPT_METHOD=sha512 }}"
###################################################################
- name: CAT II | UBTU-18-010112 | The Ubuntu operating system must allow the use of a temporary password for system logons with an immediate change to a permanent password.
  shell: chage -d 0 [UserName]
##################################
- name: CAT II | UBTU-18-010113 | The Ubuntu operating system must prevent the use of dictionary words for passwords.
  block:
    - name: Running a shell check
      shell: grep dictcheck /etc/security/pwquality.conf

    - name: Configure the Ubuntu operating system to prevent the use of dictionary words for passwords.
      lineinfile:
        dest: /etc/security/pwquality.conf
        regexp: '^dictcheck=1'
        set: "{{ dictcheck=1 }}"
#######################################################
- name: CAT II | UBTU-18-010114 | The Ubuntu operating system must require users to re-authenticate for privilege escalation and changing roles.
  block:
    - name: do the check for 'NOPASSWD' in the sudoers file
      lineinfile:
        dest: /etc/sudoers
        regexp: '^NOPASSWD'
        state: absent
    - name: do the check for '!authenticate'
      lineinfile:
        dest: /etc/sudoers
        regexp: '^!authenticate'
        state: absent
#############################################################
- name: CAT II | UBTU-18-010116 | The Ubuntu Operating system must be configured so that when passwords are changed or new passwords are established, pwquality must be used.
  block:
    - name: Verify the Ubuntu operating system has the libpam-pwquality package installed, by running the following command
      become: true
      shell: dpkg -l libpam-pwquality

    - name: Do the file check for enforcing passwords
      lineinfile:
        dest: /etc/security/pwquality.conf
        regexp: '^enforcing = 1'
        state: present

    - name: Set password retries to a maximum of 3
      lineinfile:
        dest: /etc/pam.d/common-password
        regexp: '^password requisite pam_pwquality.so retry=3'
        state: present

    - name: Configure the operating system to use "pwquality" to enforce password complexity rules.
      shell: apt-get install libpam-pwquality -y
#######################################################
